insert into table ogoud.item_trends select date_id, product_identifier_type, Pub_sts, count(distinct product_id) pcnt, count(offer_id) offr_cnt, count(barcode) top, sum(putcnt) PUT_cnt, sum(s2hcnt) S2H_cnt, sum(s2scnt) S2S_cnt, FROM_UNIXTIME(UNIX_TIMESTAMP(),'yyyy-MM-dd') datelocal from (select a.date_id, a.product_id, a.offer_id, a.product_identifier_type, t.barcode, a.Pub_sts, max(a.PUT) putcnt, max(a.S2H) s2hcnt, max(a.S2S) s2scnt from (select  distinct u.product_id, u.date_id, u.offer_id, u.product_identifier_type, get_json_object(u.product_offer_panama_json, '$.offer.productId.upc') UPC, get_json_object(u.product_offer_json,'$.offerPublishStatus') Pub_sts, case when u.product_identifier_type='DOTCOM_OFFER' and get_json_object(u.oscar_json,'$.result.offerAttributes.entry.logistics.isPutEligible')='true' then 1 else 0 end as PUT, case when u.product_identifier_type='DOTCOM_OFFER' and get_json_object(u.oscar_json,'$.result.offerAttributes.entry.logistics.isS2HEligible')='true' then 1 else 0 end as S2H, case when u.product_identifier_type='DOTCOM_OFFER' and get_json_object(u.oscar_json,'$.result.offerAttributes.entry.logistics.isS2SEligible')='true' then 1 else 0 end as S2S from catint.uber_flat_product_daily u  where u.date_id=${ydate} and u.product_identifier_type!='PRIMARY_PRODUCT_OFFER' and get_json_object(product_offer_json,'$.offerLifecycleStatus')='ACTIVE') a left outer join (select barcode from jetanalytics_assortment.top_mm_go_get_history where ds=${dt} and is_top_1m = 1) t on a.UPC=t.barcode group by a.date_id, a.product_id, a.offer_id, t.barcode, a.product_identifier_type, a.Pub_sts) b group by date_id, product_identifier_type, Pub_sts";

